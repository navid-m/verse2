<div id="sidebar" class="fixed inset-y-0 left-0 z-50 text-sm w-48 md:w-48 bg-white dark:bg-black shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out">
   <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
         <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
            <i class="fas fa-layer-group mr-2 text-blue-500"></i>
            Subverses
         </h2>
         <button id="closeSidebar" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
            <i class="fas fa-times"></i>
         </button>
      </div>

      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
         <div class="relative">
            <input type="text" id="subverseSearch" placeholder="Search subverses..."
               class="w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
         </div>
      </div>

      <div class="flex-1 overflow-y-auto">
         <div id="subversesList" class="p-2">
            <div id="loadingState" class="flex items-center justify-center py-8">
               <div class="flex items-center space-x-2 text-gray-500 dark:text-gray-400">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Loading subverses...</span>
               </div>
            </div>

            <div id="errorState" class="hidden flex items-center justify-center py-8 text-red-500">
               <div class="text-center">
                  <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                  <p>Failed to load subverses</p>
                  <button id="retryLoad" class="mt-2 px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                     Retry
                  </button>
               </div>
            </div>

            <div id="emptyState" class="hidden flex items-center justify-center py-8 text-gray-500 dark:text-gray-400">
               <div class="text-center">
                  <i class="fas fa-folder-open text-2xl mb-2"></i>
                  <p>No subverses found</p>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

<script>
class SidebarManager {
   constructor() {
      this.sidebar = document.getElementById('sidebar');
      this.overlay = document.getElementById('sidebarOverlay');
      this.toggleBtn = document.getElementById('sidebarToggle');
      this.closeBtn = document.getElementById('closeSidebar');
      this.searchInput = document.getElementById('subverseSearch');
      this.retryBtn = document.getElementById('retryLoad');
      this.subverses = [];
      this.filteredSubverses = [];

      this.init();
   }

   init() {
      console.log('Initializing SidebarManager...');
      console.log('Toggle button found:', !!this.toggleBtn);
      console.log('Search input found:', !!this.searchInput);

      this.toggleBtn.addEventListener('click', () => this.toggle());
      this.closeBtn.addEventListener('click', () => this.close());
      this.overlay.addEventListener('click', () => this.close());

      if (this.searchInput) {
         console.log('Adding search input event listener');
         this.searchInput.addEventListener('input', (e) => {
            console.log('Search input event fired with value:', e.target.value);
            this.filterSubverses(e.target.value);
         });
      } else {
         console.error('Search input not found!');
      }

      this.retryBtn.addEventListener('click', () => this.loadSubverses());

      document.addEventListener('keydown', (e) => {
         if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            this.toggle();
         }
      });

      this.loadSubverses();
   }

   toggle() {
      if (this.sidebar.classList.contains('-translate-x-full')) {
         this.open();
      } else {
         this.close();
      }
   }

   open() {
      this.sidebar.classList.remove('-translate-x-full');
      this.overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      if (this.toggleBtn) {
         this.toggleBtn.style.opacity = '0';
         this.toggleBtn.style.pointerEvents = 'none';
      }
   }

   close() {
      this.sidebar.classList.add('-translate-x-full');
      this.overlay.classList.add('hidden');
      document.body.style.overflow = '';
      if (this.toggleBtn) {
         this.toggleBtn.style.opacity = '1';
         this.toggleBtn.style.pointerEvents = 'auto';
      }
   }

   async loadSubverses() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');

      if (loadingState) {
         loadingState.classList.remove('hidden');
      }
      if (errorState) {
         errorState.classList.add('hidden');
      }

      try {
         console.log('Loading subverses from API...');
         const response = await fetch('/api/subverses');
         console.log('API response status:', response.status);

         if (!response.ok) {
            throw new Error('Failed to load subverses');
         }

         const data = await response.json();
         console.log('API response data:', data);
         console.log('Subverses count:', data.subverses ? data.subverses.length : 0);

         this.subverses = data.subverses || [];
         this.filteredSubverses = [...this.subverses];

         console.log('Loaded subverses:', this.subverses);
         this.renderSubverses();
      } catch (error) {
         console.error('Error loading subverses:', error);
         if (loadingState) {
            loadingState.classList.add('hidden');
         }
         if (errorState) {
            errorState.classList.remove('hidden');
         }
      }
   }

   filterSubverses(query) {
      console.log('Filtering subverses with query:', query);
      console.log('Original subverses count:', this.subverses.length);

      if (!query.trim()) {
         this.filteredSubverses = [...this.subverses];
         console.log('No query, showing all subverses');
      } else {
         this.filteredSubverses = this.subverses.filter(subverse =>
            subverse.name.toLowerCase().includes(query.toLowerCase())
         );
         console.log('Filtered subverses count:', this.filteredSubverses.length);
         console.log('Filtered subverses:', this.filteredSubverses.map(s => s.name));
      }
      this.renderSubverses();
   }

   renderSubverses() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const emptyState = document.getElementById('emptyState');
      const subversesList = document.getElementById('subversesList');

      if (loadingState) {
         loadingState.classList.add('hidden');
      }

      if (errorState) {
         errorState.classList.add('hidden');
      }

      if (emptyState) {
         emptyState.classList.add('hidden');
      }

      if (subversesList) {
         subversesList.classList.remove('hidden');
      }

      if (this.filteredSubverses.length === 0) {
         if (emptyState) {
            emptyState.classList.remove('hidden');
         }
         return;
      }

      if (emptyState) {
         emptyState.classList.add('hidden');
      }

      const html = this.filteredSubverses.map(subverse => `
         <a href="/s/${subverse.name}"
            class="block px-3 py-2 mx-2 my-1 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
            <div class="flex items-center">
               <i class="fas fa-layer-group mr-3 text-blue-500"></i>
               <span class="font-medium">/${subverse.name}/</span>
            </div>
         </a>
      `).join('');

      subversesList.innerHTML = html;
   }
}

document.addEventListener('DOMContentLoaded', () => {
   new SidebarManager();
});
</script>
